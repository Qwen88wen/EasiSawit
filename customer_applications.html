<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Applications - EasiSawit (Optimized)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="translations.js?v=5.0"></script>
  <script>
    // Access Control
    async function checkAuth() {
      try {
        const response = await fetch('api/check_auth.php', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok && response.status === 401) {
          alert("Access denied. Please login first.");
          window.location.href = "login.html";
        }
      } catch (error) {
        console.error("Auth check error:", error);
      }
    }

    checkAuth();
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .application-row {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .application-row:hover {
      background-color: #f9fafb;
    }

    .application-row.selected {
      background-color: #dbeafe;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-slide-in {
      animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-approved {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-rejected {
      background: #fee2e2;
      color: #991b1b;
    }

    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      z-index: 2000;
      animation: slideInRight 0.3s ease-out;
      max-width: 400px;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .toast.success {
      background: #10b981;
    }

    .toast.error {
      background: #ef4444;
    }

    .toast.info {
      background: #3b82f6;
    }

    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Checkbox styling */
    input[type="checkbox"] {
      cursor: pointer;
      width: 18px;
      height: 18px;
    }

    /* Table compact mode */
    .table-compact td, .table-compact th {
      padding: 8px 12px;
    }
  </style>
</head>
<body class="p-6">
  <!-- Header -->
  <div class="glass-card p-6 mb-6 animate-slide-in">
    <div class="flex items-center justify-between flex-wrap gap-4">
      <div class="flex items-center gap-4">
        <svg class="w-12 h-12" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <circle cx="50" cy="50" r="45" fill="#10b981"/>
          <g transform="translate(50, 50)">
            <ellipse cx="0" cy="-15" rx="8" ry="20" fill="#059669"/>
            <ellipse cx="-12" cy="-8" rx="8" ry="20" fill="#059669" transform="rotate(-60)"/>
            <ellipse cx="12" cy="-8" rx="8" ry="20" fill="#059669" transform="rotate(60)"/>
            <circle cx="0" cy="0" r="12" fill="#065f46"/>
            <rect x="-3" y="0" width="6" height="30" fill="#92400e" rx="2"/>
          </g>
        </svg>
        <div>
          <h1 class="text-3xl font-bold text-gray-900" id="pageTitle">Customer Applications</h1>
          <p class="text-gray-600" id="pageSubtitle">Manage customer registration requests</p>
        </div>
      </div>
      <div class="flex gap-3 flex-wrap">
        <button onclick="loadApplications()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 transition flex items-center gap-2">
          <i data-lucide="refresh-cw" style="width: 18px; height: 18px;"></i>
          <span id="refreshBtn">Refresh</span>
        </button>
        <button onclick="window.location.href='index.html'" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition flex items-center gap-2">
          <i data-lucide="arrow-left" style="width: 18px; height: 18px;"></i>
          <span id="backBtn">Back</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Filters and Search -->
  <div class="glass-card p-6 mb-6 animate-slide-in" style="animation-delay: 0.1s">
    <div class="space-y-4">
      <!-- Status Filter -->
      <div class="flex gap-4 flex-wrap">
        <button onclick="filterApplications('all')" id="filter-all" class="px-6 py-2 rounded-lg font-semibold bg-emerald-600 text-white hover:bg-emerald-700 transition">
          All Applications
        </button>
        <button onclick="filterApplications('pending')" id="filter-pending" class="px-6 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 transition">
          Pending
        </button>
        <button onclick="filterApplications('approved')" id="filter-approved" class="px-6 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 transition">
          Approved
        </button>
        <button onclick="filterApplications('rejected')" id="filter-rejected" class="px-6 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 transition">
          Rejected
        </button>
      </div>

      <!-- Search and Sort -->
      <div class="flex gap-4 flex-wrap">
        <div class="flex-1 min-w-[300px]">
          <div class="relative">
            <input
              type="text"
              id="searchInput"
              placeholder="Search by name, email, contact, or location..."
              class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
              oninput="handleSearch()"
            >
            <i data-lucide="search" style="width: 18px; height: 18px; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af;"></i>
          </div>
        </div>

        <select id="sortSelect" onchange="handleSort()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
          <option value="date-desc">Latest First</option>
          <option value="date-asc">Oldest First</option>
          <option value="name-asc">Name (A-Z)</option>
          <option value="name-desc">Name (Z-A)</option>
          <option value="acres-desc">Acres (High-Low)</option>
          <option value="acres-asc">Acres (Low-High)</option>
        </select>

        <button onclick="toggleAdvancedFilters()" class="px-6 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition flex items-center gap-2">
          <i data-lucide="filter" style="width: 18px; height: 18px;"></i>
          Advanced
        </button>
      </div>

      <!-- Advanced Filters (Hidden by default) -->
      <div id="advancedFilters" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 pt-4 border-t border-gray-200">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
          <input type="date" id="dateFrom" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="applyFilters()">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
          <input type="date" id="dateTo" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="applyFilters()">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Min Acres</label>
          <input type="number" id="minAcres" placeholder="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg" oninput="applyFilters()">
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <div class="glass-card p-6 animate-slide-in" style="animation-delay: 0.2s">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-gray-600 text-sm font-medium mb-2">Total Applications</p>
          <p class="text-3xl font-bold text-gray-900" id="totalCount">0</p>
        </div>
        <div class="p-3 bg-blue-100 rounded-lg">
          <i data-lucide="users" style="width: 24px; height: 24px; color: #2563eb;"></i>
        </div>
      </div>
    </div>

    <div class="glass-card p-6 animate-slide-in" style="animation-delay: 0.3s">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-gray-600 text-sm font-medium mb-2">Pending Review</p>
          <p class="text-3xl font-bold text-yellow-600" id="pendingCount">0</p>
        </div>
        <div class="p-3 bg-yellow-100 rounded-lg">
          <i data-lucide="clock" style="width: 24px; height: 24px; color: #ca8a04;"></i>
        </div>
      </div>
    </div>

    <div class="glass-card p-6 animate-slide-in" style="animation-delay: 0.4s">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-gray-600 text-sm font-medium mb-2">Approved</p>
          <p class="text-3xl font-bold text-green-600" id="approvedCount">0</p>
        </div>
        <div class="p-3 bg-green-100 rounded-lg">
          <i data-lucide="check-circle" style="width: 24px; height: 24px; color: #16a34a;"></i>
        </div>
      </div>
    </div>

    <div class="glass-card p-6 animate-slide-in" style="animation-delay: 0.5s">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-gray-600 text-sm font-medium mb-2">Rejected</p>
          <p class="text-3xl font-bold text-red-600" id="rejectedCount">0</p>
        </div>
        <div class="p-3 bg-red-100 rounded-lg">
          <i data-lucide="x-circle" style="width: 24px; height: 24px; color: #dc2626;"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Actions -->
  <div id="bulkActionsBar" class="glass-card p-4 mb-6 hidden animate-slide-in">
    <div class="flex items-center justify-between flex-wrap gap-4">
      <div class="flex items-center gap-3">
        <span class="font-semibold text-gray-900"><span id="selectedCount">0</span> <span id="selectedText">selected</span></span>
        <button onclick="selectAll()" class="text-emerald-600 hover:text-emerald-700 font-medium text-sm" id="selectAllBtn">Select All</button>
        <button onclick="deselectAll()" class="text-gray-600 hover:text-gray-700 font-medium text-sm" id="deselectAllBtn">Deselect All</button>
      </div>
      <div class="flex gap-3">
        <button onclick="bulkApprove()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
          <i data-lucide="check" style="width: 18px; height: 18px;"></i>
          <span id="bulkApproveBtn">Bulk Approve</span>
        </button>
        <button onclick="bulkReject()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition flex items-center gap-2">
          <i data-lucide="x" style="width: 18px; height: 18px;"></i>
          <span id="bulkRejectBtn">Bulk Reject</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Applications Table -->
  <div class="glass-card p-6 animate-slide-in custom-scrollbar" style="animation-delay: 0.6s; max-height: 70vh; overflow-y: auto;">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
        <i data-lucide="inbox" style="width: 24px; height: 24px;"></i>
        <span id="applicationsListTitle">Applications List</span> (<span id="displayedCount">0</span>)
      </h3>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="space-y-4">
      <div class="skeleton h-20"></div>
      <div class="skeleton h-20"></div>
      <div class="skeleton h-20"></div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden text-center py-12">
      <i data-lucide="inbox" style="width: 64px; height: 64px; color: #9ca3af; margin: 0 auto 16px;"></i>
      <p class="text-gray-500 text-lg" id="noApplicationsText">No applications found</p>
    </div>

    <!-- Table -->
    <div id="applicationsTable" class="hidden overflow-x-auto">
      <table class="w-full table-compact">
        <thead class="bg-gray-50 sticky top-0">
          <tr>
            <th class="text-left p-3 font-semibold text-gray-700">
              <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
            </th>
            <th class="text-left p-3 font-semibold text-gray-700" id="tableHeaderName">Name</th>
            <th class="text-left p-3 font-semibold text-gray-700" id="tableHeaderEmail">Email</th>
            <th class="text-left p-3 font-semibold text-gray-700" id="tableHeaderContact">Contact</th>
            <th class="text-left p-3 font-semibold text-gray-700" id="tableHeaderLocation">Location</th>
            <th class="text-left p-3 font-semibold text-gray-700" id="tableHeaderAcres">Acres</th>
            <th class="text-left p-3 font-semibold text-gray-700" id="tableHeaderStatus">Status</th>
            <th class="text-left p-3 font-semibold text-gray-700" id="tableHeaderDate">Date</th>
            <th class="text-left p-3 font-semibold text-gray-700" id="tableHeaderActions">Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Rows will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detailModal" class="modal">
    <div class="modal-content fade-in">
      <div class="p-6">
        <div class="flex justify-between items-start mb-6">
          <h3 class="text-2xl font-bold text-gray-900" id="modalTitle">Application Details</h3>
          <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition">
            <i data-lucide="x" style="width: 24px; height: 24px;"></i>
          </button>
        </div>

        <div id="modalContent" class="custom-scrollbar" style="max-height: 60vh; overflow-y: auto;">
          <!-- Details will be inserted here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Get current language and translations
    const currentLang = localStorage.getItem('language') || 'en';
    const t = translations[currentLang].applicationsView;

    // Helper function to get translated status
    function getStatusText(status) {
      const statusMap = {
        'pending': t.pending,
        'approved': t.approved,
        'rejected': t.rejected
      };
      return statusMap[status.toLowerCase()] || status;
    }

    // Apply translations to static elements
    function applyTranslations() {
      // Header
      const pageTitle = document.getElementById('pageTitle');
      if (pageTitle) pageTitle.textContent = t.title;

      const pageSubtitle = document.getElementById('pageSubtitle');
      if (pageSubtitle) pageSubtitle.textContent = t.subtitle;

      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) refreshBtn.textContent = t.refresh;

      const backBtn = document.getElementById('backBtn');
      if (backBtn) backBtn.textContent = t.back;

      // Status filter buttons
      const buttons = {
        'filter-all': t.allApplications,
        'filter-pending': t.pending,
        'filter-approved': t.approved,
        'filter-rejected': t.rejected
      };
      Object.entries(buttons).forEach(([id, text]) => {
        const btn = document.getElementById(id);
        if (btn) btn.textContent = text;
      });

      // Statistics cards
      const statsLabels = [
        { selector: '.glass-card:nth-child(1) .text-gray-600', text: t.totalApplications },
        { selector: '.glass-card:nth-child(2) .text-gray-600', text: t.pendingReview },
        { selector: '.glass-card:nth-child(3) .text-gray-600', text: t.approved },
        { selector: '.glass-card:nth-child(4) .text-gray-600', text: t.rejected }
      ];
      statsLabels.forEach(({ selector, text }) => {
        const el = document.querySelector(selector);
        if (el) el.textContent = text;
      });

      // Bulk actions
      const selectedText = document.getElementById('selectedText');
      if (selectedText) selectedText.textContent = t.selected;

      const selectAllBtn = document.getElementById('selectAllBtn');
      if (selectAllBtn) selectAllBtn.textContent = t.selectAll;

      const deselectAllBtn = document.getElementById('deselectAllBtn');
      if (deselectAllBtn) deselectAllBtn.textContent = t.deselectAll;

      const bulkApproveBtn = document.getElementById('bulkApproveBtn');
      if (bulkApproveBtn) bulkApproveBtn.textContent = t.bulkApprove;

      const bulkRejectBtn = document.getElementById('bulkRejectBtn');
      if (bulkRejectBtn) bulkRejectBtn.textContent = t.bulkReject;

      // Applications list
      const applicationsListTitle = document.getElementById('applicationsListTitle');
      if (applicationsListTitle) applicationsListTitle.textContent = t.applicationsList;

      const noApplicationsText = document.getElementById('noApplicationsText');
      if (noApplicationsText) noApplicationsText.textContent = t.noApplicationsFound;

      // Table headers
      const tableHeaderName = document.getElementById('tableHeaderName');
      if (tableHeaderName) tableHeaderName.textContent = t.name;

      const tableHeaderEmail = document.getElementById('tableHeaderEmail');
      if (tableHeaderEmail) tableHeaderEmail.textContent = t.email;

      const tableHeaderContact = document.getElementById('tableHeaderContact');
      if (tableHeaderContact) tableHeaderContact.textContent = t.contact;

      const tableHeaderLocation = document.getElementById('tableHeaderLocation');
      if (tableHeaderLocation) tableHeaderLocation.textContent = t.location;

      const tableHeaderAcres = document.getElementById('tableHeaderAcres');
      if (tableHeaderAcres) tableHeaderAcres.textContent = t.acres;

      const tableHeaderStatus = document.getElementById('tableHeaderStatus');
      if (tableHeaderStatus) tableHeaderStatus.textContent = t.status;

      const tableHeaderDate = document.getElementById('tableHeaderDate');
      if (tableHeaderDate) tableHeaderDate.textContent = t.date;

      const tableHeaderActions = document.getElementById('tableHeaderActions');
      if (tableHeaderActions) tableHeaderActions.textContent = t.actions;

      // Search placeholder
      const searchInput = document.getElementById('searchInput');
      if (searchInput) searchInput.placeholder = t.searchPlaceholder;

      // Sort options
      const sortSelect = document.getElementById('sortSelect');
      if (sortSelect) {
        sortSelect.options[0].text = t.sortLatestFirst;
        sortSelect.options[1].text = t.sortOldestFirst;
        sortSelect.options[2].text = t.sortNameAsc;
        sortSelect.options[3].text = t.sortNameDesc;
        sortSelect.options[4].text = t.sortAcresDesc;
        sortSelect.options[5].text = t.sortAcresAsc;
      }

      // Advanced filter labels
      const advancedLabels = document.querySelectorAll('#advancedFilters label');
      if (advancedLabels[0]) advancedLabels[0].textContent = t.dateFrom;
      if (advancedLabels[1]) advancedLabels[1].textContent = t.dateTo;
      if (advancedLabels[2]) advancedLabels[2].textContent = t.minAcres;

      // Advanced button text
      const advBtn = document.querySelector('button[onclick="toggleAdvancedFilters()"]');
      if (advBtn) {
        const textNode = Array.from(advBtn.childNodes).find(node => node.nodeType === 3);
        if (textNode) textNode.textContent = ` ${t.advanced}`;
      }

      // Modal title
      const modalTitle = document.getElementById('modalTitle');
      if (modalTitle) modalTitle.textContent = t.applicationDetails;
    }

    let allApplications = [];
    let filteredApplications = [];
    let currentFilter = 'all';
    let selectedIds = new Set();

    // Load applications from API
    async function loadApplications() {
      const loadingState = document.getElementById('loadingState');
      const emptyState = document.getElementById('emptyState');
      const table = document.getElementById('applicationsTable');

      loadingState.classList.remove('hidden');
      emptyState.classList.add('hidden');
      table.classList.add('hidden');

      try {
        const response = await fetch('api/api_get_customer_applications.php');
        if (!response.ok) throw new Error('Failed to fetch applications');

        const data = await response.json();
        allApplications = data.applications || [];

        updateStatistics();
        applyFilters();

        loadingState.classList.add('hidden');
        showToast(t.applicationsLoadedSuccessfully, 'success');
      } catch (error) {
        console.error('Error loading applications:', error);
        loadingState.classList.add('hidden');
        emptyState.classList.remove('hidden');
        showToast(t.errorLoadingApplications + ' ' + error.message, 'error');
      }
    }

    // Update statistics
    function updateStatistics() {
      const total = allApplications.length;
      const pending = allApplications.filter(app => app.status === 'pending').length;
      const approved = allApplications.filter(app => app.status === 'approved').length;
      const rejected = allApplications.filter(app => app.status === 'rejected').length;

      document.getElementById('totalCount').textContent = total;
      document.getElementById('pendingCount').textContent = pending;
      document.getElementById('approvedCount').textContent = approved;
      document.getElementById('rejectedCount').textContent = rejected;
    }

    // Filter by status
    function filterApplications(status) {
      currentFilter = status;

      // Update button styles
      document.querySelectorAll('[id^="filter-"]').forEach(btn => {
        btn.className = 'px-6 py-2 rounded-lg font-semibold bg-white text-gray-700 hover:bg-gray-100 transition';
      });
      document.getElementById(`filter-${status}`).className = 'px-6 py-2 rounded-lg font-semibold bg-emerald-600 text-white hover:bg-emerald-700 transition';

      applyFilters();
    }

    // Apply all filters
    function applyFilters() {
      let filtered = [...allApplications];

      // Status filter
      if (currentFilter !== 'all') {
        filtered = filtered.filter(app => app.status === currentFilter);
      }

      // Search filter
      const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
      if (searchTerm) {
        filtered = filtered.filter(app =>
          (app.name?.toLowerCase().includes(searchTerm)) ||
          (app.email?.toLowerCase().includes(searchTerm)) ||
          (app.contact?.toLowerCase().includes(searchTerm)) ||
          (app.location?.toLowerCase().includes(searchTerm))
        );
      }

      // Date range filter
      const dateFrom = document.getElementById('dateFrom')?.value;
      const dateTo = document.getElementById('dateTo')?.value;
      if (dateFrom) {
        filtered = filtered.filter(app => new Date(app.submitted_at) >= new Date(dateFrom));
      }
      if (dateTo) {
        filtered = filtered.filter(app => new Date(app.submitted_at) <= new Date(dateTo + ' 23:59:59'));
      }

      // Acres filter
      const minAcres = parseFloat(document.getElementById('minAcres')?.value || 0);
      if (minAcres > 0) {
        filtered = filtered.filter(app => parseFloat(app.acres || 0) >= minAcres);
      }

      filteredApplications = filtered;
      handleSort();
    }

    // Handle search
    function handleSearch() {
      applyFilters();
    }

    // Handle sort
    function handleSort() {
      const sortValue = document.getElementById('sortSelect').value;
      let sorted = [...filteredApplications];

      switch (sortValue) {
        case 'date-desc':
          sorted.sort((a, b) => new Date(b.submitted_at) - new Date(a.submitted_at));
          break;
        case 'date-asc':
          sorted.sort((a, b) => new Date(a.submitted_at) - new Date(b.submitted_at));
          break;
        case 'name-asc':
          sorted.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
          break;
        case 'name-desc':
          sorted.sort((a, b) => (b.name || '').localeCompare(a.name || ''));
          break;
        case 'acres-desc':
          sorted.sort((a, b) => (parseFloat(b.acres || 0)) - (parseFloat(a.acres || 0)));
          break;
        case 'acres-asc':
          sorted.sort((a, b) => (parseFloat(a.acres || 0)) - (parseFloat(b.acres || 0)));
          break;
      }

      displayApplications(sorted);
    }

    // Display applications in table
    function displayApplications(applications) {
      const table = document.getElementById('applicationsTable');
      const emptyState = document.getElementById('emptyState');
      const tableBody = document.getElementById('tableBody');

      document.getElementById('displayedCount').textContent = applications.length;

      if (applications.length === 0) {
        table.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      table.classList.remove('hidden');

      tableBody.innerHTML = applications.map(app => `
        <tr class="application-row border-t border-gray-200 ${selectedIds.has(app.id) ? 'selected' : ''}" onclick="showDetails(${app.id})">
          <td class="p-3" onclick="event.stopPropagation()">
            <input type="checkbox" ${app.status !== 'pending' ? 'disabled' : ''} ${selectedIds.has(app.id) ? 'checked' : ''} onchange="toggleSelect(${app.id}, this.checked)">
          </td>
          <td class="p-3 font-medium text-gray-900">${app.name}</td>
          <td class="p-3 text-gray-600">${app.email || '-'}</td>
          <td class="p-3 text-gray-600">${app.contact || '-'}</td>
          <td class="p-3 text-gray-600">${app.location || '-'}</td>
          <td class="p-3 text-gray-600">${app.acres ? parseFloat(app.acres).toFixed(2) : '-'}</td>
          <td class="p-3">
            <span class="badge badge-${app.status.toLowerCase()}">${getStatusText(app.status)}</span>
          </td>
          <td class="p-3 text-gray-600 text-sm">${new Date(app.submitted_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</td>
          <td class="p-3" onclick="event.stopPropagation()">
            ${app.status === 'pending' ? `
              <div class="flex gap-2">
                <button onclick="quickApprove(${app.id})" class="text-green-600 hover:text-green-700" title="Approve">
                  <i data-lucide="check-circle" style="width: 20px; height: 20px;"></i>
                </button>
                <button onclick="quickReject(${app.id})" class="text-red-600 hover:text-red-700" title="Reject">
                  <i data-lucide="x-circle" style="width: 20px; height: 20px;"></i>
                </button>
              </div>
            ` : '-'}
          </td>
        </tr>
      `).join('');

      lucide.createIcons();
      updateBulkActionsBar();
    }

    // Toggle advanced filters
    function toggleAdvancedFilters() {
      const advancedFilters = document.getElementById('advancedFilters');
      advancedFilters.classList.toggle('hidden');
    }

    // Selection functions
    function toggleSelect(id, checked) {
      if (checked) {
        selectedIds.add(id);
      } else {
        selectedIds.delete(id);
      }
      updateBulkActionsBar();
      applyFilters(); // Refresh display
    }

    function toggleSelectAll() {
      const checkbox = document.getElementById('selectAllCheckbox');
      if (checkbox.checked) {
        selectAll();
      } else {
        deselectAll();
      }
    }

    function selectAll() {
      selectedIds.clear();
      filteredApplications.forEach(app => {
        if (app.status === 'pending') {
          selectedIds.add(app.id);
        }
      });
      document.getElementById('selectAllCheckbox').checked = true;
      updateBulkActionsBar();
      applyFilters(); // Refresh display
    }

    function deselectAll() {
      selectedIds.clear();
      document.getElementById('selectAllCheckbox').checked = false;
      updateBulkActionsBar();
      applyFilters(); // Refresh display
    }

    function updateBulkActionsBar() {
      const bar = document.getElementById('bulkActionsBar');
      const count = selectedIds.size;
      document.getElementById('selectedCount').textContent = count;

      if (count > 0) {
        bar.classList.remove('hidden');
      } else {
        bar.classList.add('hidden');
      }
    }

    // Quick actions , status update 
    async function quickApprove(id) {
  await updateStatus(id, 'approved', false);
}

async function quickReject(id) {
  const reason = prompt(t.enterRejectionReason);
  await updateStatus(id, 'rejected', false, reason);
}


    // Bulk actions
    async function bulkApprove() {
      if (selectedIds.size === 0) {
        showToast(t.noApplicationsSelected, 'error');
        return;
      }

      if (!confirm(`${t.confirmBulkApprove} ${selectedIds.size} ${t.applications}`)) {
        return;
      }

      const ids = Array.from(selectedIds);
      let successCount = 0;
      let errorCount = 0;

      for (const id of ids) {
        try {
          const response = await fetch('api/api_approve_application.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ application_id: id })
          });

          if (response.ok) {
            successCount++;
          } else {
            errorCount++;
          }
        } catch (error) {
          errorCount++;
        }
      }

      showToast(`${t.approved}: ${successCount}, ${t.failed}: ${errorCount}`, successCount > 0 ? 'success' : 'error');
      deselectAll();
      loadApplications();
    }

    async function bulkReject() {
      if (selectedIds.size === 0) {
        showToast(t.noApplicationsSelected, 'error');
        return;
      }

      const reason = prompt(t.enterRejectionReason);
      if (!confirm(`${t.confirmBulkReject} ${selectedIds.size} ${t.applications}`)) {
        return;
      }

      const ids = Array.from(selectedIds);
      let successCount = 0;
      let errorCount = 0;

      for (const id of ids) {
        try {
          const response = await fetch('api/api_reject_application.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ application_id: id, rejection_reason: reason })
          });

          if (response.ok) {
            successCount++;
          } else {
            errorCount++;
          }
        } catch (error) {
          errorCount++;
        }
      }

      showToast(`${t.rejected}: ${successCount}, ${t.failed}: ${errorCount}`, successCount > 0 ? 'success' : 'error');
      deselectAll();
      loadApplications();
    }

    // Show application details modal
    function showDetails(id) {
      const app = allApplications.find(a => a.id === id);
      if (!app) return;

      const modalContent = document.getElementById('modalContent');
      modalContent.innerHTML = `
        <div class="space-y-6">
          <div>
            <label class="text-sm font-semibold text-gray-600">${t.status}</label>
            <div class="mt-2">
              <span class="badge badge-${app.status.toLowerCase()}">${getStatusText(app.status)}</span>
            </div>
          </div>

          <div>
            <label class="text-sm font-semibold text-gray-600">${t.fullName}</label>
            <p class="mt-1 text-lg font-medium text-gray-900">${app.name}</p>
          </div>

          <div>
            <label class="text-sm font-semibold text-gray-600">${t.emailAddress}</label>
            <p class="mt-1 text-gray-900">${app.email || t.notProvided}</p>
          </div>

          <div>
            <label class="text-sm font-semibold text-gray-600">${t.contactNumber}</label>
            <p class="mt-1 text-gray-900">${app.contact || t.notProvided}</p>
          </div>

          ${app.location ? `
          <div>
            <label class="text-sm font-semibold text-gray-600">${t.location}</label>
            <p class="mt-1 text-gray-900">${app.location}</p>
          </div>
          ` : ''}

          ${app.acres ? `
          <div>
            <label class="text-sm font-semibold text-gray-600">${t.acres}</label>
            <p class="mt-1 text-gray-900">${parseFloat(app.acres).toFixed(2)} ${t.acres.toLowerCase()}</p>
          </div>
          ` : ''}

          ${app.company_name ? `
          <div>
            <label class="text-sm font-semibold text-gray-600">${t.companyName}</label>
            <p class="mt-1 text-gray-900">${app.company_name}</p>
          </div>
          ` : ''}

          ${app.rate_requested ? `
          <div>
            <label class="text-sm font-semibold text-gray-600">${t.requestedRate}</label>
            <p class="mt-1 text-gray-900">RM ${parseFloat(app.rate_requested).toFixed(2)}</p>
          </div>
          ` : ''}

          <div>
            <label class="text-sm font-semibold text-gray-600">${t.applicationDate}</label>
            <p class="mt-1 text-gray-900">${new Date(app.submitted_at).toLocaleString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              hour12: true
            })}</p>
          </div>

          ${app.reviewed_at ? `
          <div>
            <label class="text-sm font-semibold text-gray-600">${t.reviewedAt}</label>
            <p class="mt-1 text-gray-900">${new Date(app.reviewed_at).toLocaleString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              hour12: true
            })}</p>
          </div>
          ` : ''}

          ${app.reviewed_by ? `
          <div>
            <label class="text-sm font-semibold text-gray-600">${t.reviewedBy}</label>
            <p class="mt-1 text-gray-900">${app.reviewed_by}</p>
          </div>
          ` : ''}

          ${app.rejection_reason ? `
          <div>
            <label class="text-sm font-semibold text-gray-600">${t.rejectionReason}</label>
            <p class="mt-1 text-gray-900">${app.rejection_reason}</p>
          </div>
          ` : ''}

          ${app.status === 'pending' ? `
          <div class="flex gap-4 pt-4 border-t border-gray-200">
            <button onclick="updateStatus(${app.id}, 'approved', true)" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold flex items-center justify-center gap-2">
              <i data-lucide="check" style="width: 20px; height: 20px;"></i>
              ${t.approve}
            </button>
            <button onclick="updateStatus(${app.id}, 'rejected', true)" class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition font-semibold flex items-center justify-center gap-2">
              <i data-lucide="x" style="width: 20px; height: 20px;"></i>
              ${t.reject}
            </button>
          </div>
          ` : ''}
        </div>
      `;

      document.getElementById('detailModal').classList.add('active');
      lucide.createIcons();
    }

    // Close modal
    function closeModal() {
      document.getElementById('detailModal').classList.remove('active');
    }

    // Update application status
    async function updateStatus(id, newStatus, closeModalAfter = true, rejectionReason = null) {
      const isApprove = newStatus === 'approved';

      // Get rejection reason if rejecting and not provided
      if (!isApprove && !rejectionReason) {
        rejectionReason = prompt(t.enterRejectionReason);
      }

      try {
        const apiUrl = isApprove ? 'api/api_approve_application.php' : 'api/api_reject_application.php';
        const requestBody = isApprove
          ? { application_id: id }
          : { application_id: id, rejection_reason: rejectionReason };

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || t.failedToUpdateStatus);
        }

        const result = await response.json();
        showToast(result.message || t.statusUpdated, 'success');

        if (closeModalAfter) {
          closeModal();
        }
        loadApplications();
      } catch (error) {
        console.error('Error updating status:', error);
        showToast(t.errorUpdatingStatus + ' ' + error.message, 'error');
      }
    }


    // Toast notification
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Close modal when clicking outside
    document.getElementById('detailModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    // Initialize
    applyTranslations();
    lucide.createIcons();
    loadApplications();
  </script>
</body>
</html>
